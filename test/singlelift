#!/bin/sh
# singlelift - run a single Subversion conversion test
#
# The REPOSURGEON environment variable can be used to substitute in a
# different implementation.

. common-setup.sh

# Use absolute path so tests that change working directory still use 
# scripts from parent directory.  Note that using $PWD seems to fail
# here under Gitlab's CI environment.
PATH=$(realpath ..):$(realpath .):${PATH}

# Without this, under CentOS Python may emit invisible ANSI strings
# that confuse diff
TERM=dumb

mode=check
case $1 in
    --view) mode=view; shift ;;
esac

for x in $*;
do
    echo "Test $x"
    case $mode in
	view)
	    ${REPOSURGEON:-reposurgeon} "read <$1.svn" "prefer git" "write -" 2>&1;;
	*)
	    ${REPOSURGEON:-reposurgeon} "read <$1.svn" "prefer git" "write -" 2>&1 | diff -u $1.chk - ;;
    esac
done
