== Testing the code ==

"make" here in the test directoy runs a complete set of regression
tests. It's what "make check" in the main directory redirects to.

If you get a failure on the repotool-initialize-cvs-git test, but
nowgere else, try updating your versions of CVS and cvs-fast-export
ansd trying again.

There are tools and makefile productions for finer-grained testing.  
Their behavior is controlled by two variables:

REPOSURGEON: either reposurgeon (the default) or pyreposurgeon

TESTOPT: Use this to pass in a command or option setting, such
as "set experimental",

STOPOUT: 1 (the default) produces a bailout after the first failed
test.  Set it to 0 to continue after failed tests - you have to do
this on the make command line, e.g. "cd test; make STOPOUT=0
fi-regress".  Note, the output from this may be voluminous and
unuseful.

To run a single test:

   cd test; ./singletest foo

will check the actual result of the script in foo.tst against its expected
output in foo.chk.  No output other than the test notice is good.

The "liftcheck" script is useful for testing the conversion correctness
of a Subversion strream:

   cd test; liftcheck foo.svn
   
No output means that a compare-all showed no errors or warnings.

To allow the code to emit a stack trace, set verbose to 1 or higher.

= Notes on the test machinery = 

A .fi extension means it's a git fast-import stream.  
A .svn extension means it's a Subversion repo dump.
A .chk extension means it's expected output from a test.
A .tst extension means it's a test driver script.

The "singletest" script takes the stem of a .tst file name, captures stdout
and stderr, and diffs the result against the corresponding check file.

The "singlelift" script takes the stem of a .svn file name, captures stdout
and stderr, and diffs the resultihg Subversion and git repos.

The "liftcheck" script takes a Subversion stream file, builds a Git
repository from it, and checks for differences using repotool's
compare-all function.

== The scripts ==

=== fi-to-fi ===

Builds a git repo from a fast-import stream on stdin, or streams an
existing repo to stdout.

=== hg-to-fi ===

Builds an hg repo from a fast-import stream on stdin, or streams an
existing repo to stdout.

=== svn-to-svn ===

Build a Subversion repo from a Subversion stream dump on stdin, or
dump an existing repo as a stream to stdout.  Can also be used to edit
a Subversion test load, regenerating its checksums.

=== svn-to-git ===

Build a Subversion repo from a Subversion stream dump on stdin,
convert it to a local git repository, and stream the result to
standard output. Mainly a wrapper around git-svn, to be used
for comparison tests.  Can also be used to test against agito
and svn2git.

To add a new tool for comparison, do something like:

   git submodule add GIT-URL/foobar externals/foobar
   git update submodules

from the repo root.

=== liftcheck ===

Takes a named Subversion dump and compare a checkout of it with
its git conversion at all tags and branches.

== The tests ==

Keeping live Subversion repos under version control doesn't work very well; 
in particular, things like the entries file change too often.  So what we 
do is keep Subversion dump files and rebuild the repo before each test.

In general, a file named foo.chk is the expected output from a test involving
either some operation test on an input stream in foo.fi or a repo conversion
from foo.svn.

To see summary lines from all tests, 'make testlist'.  

The Subversion dumpfiles have summary comments in them that abuse a loophole
in Subversion's parser - header lines that begin with whitespace are ignored.
When you create a new one, insert a second line that begins with a space and
two pound signs.

=== Making new Subversion test loads ===

1. To create a new Subversion test repo, 'make svn-flat' or 'make svn-branchy'.

2. To clone an existing test load foo.svn into the test repo,
'svn-to-svn -n <foo.svn'

3. To copy trunk, creating a tag named 'foo'

   svn copy file://${PWD}/test-repo/trunk file://${PWD}/test-repo/tags/foo

4. To delete a branch foo

   svn delete file://${PWD}/test-repo/branches/foo

5. 'make svn-dump' will dump the new test load to stdout.

== The agito test case ==

Samuel Howard had this to say:

git-svn's handling of tags is broken.

In this demonstration repository, a trunk directory of /trunk/proj exists,
containing some code.  This is improperly tagged by doing:

	svn cp trunk tags/proj-1.0

Where as what should have been done is this:

	svn cp trunk/proj tags/proj-1.0

This is significant because this is exactly what the CVS to SVN conversion
script (cvs2svn) does, to handle the fact that a CVS repository can contain
multiple modules.  Fixing a "mistake" like this is therefore necessary when
converting to SVN, to get tags stored properly.

In the SVN repository, this is fixed by deleting the branch and recreating
it properly (ie. the second command above).  To verify that this has been
done successfully, try this:

	svn log file://$PWD/myrepo/tags/proj-1.0

outputs:

	-----------------------------------------------------------------------
	r4 | fraggle | 2009-10-02 23:37:42 +0100 (Fri, 02 Oct 2009) | 2 lines

	Recreating the tag properly.

	-----------------------------------------------------------------------
	r1 | fraggle | 2009-10-02 23:36:41 +0100 (Fri, 02 Oct 2009) | 2 lines

	Initial import.

	-----------------------------------------------------------------------

Only the history of the directory being tagged and the commit that created the
tag are shown.  The "mistake" is kept in the history of /tags, but not in
the history of the tag itself.

The repository is then converted to git, using git-svn (see the shell script).
Two tags are created (proj-1.0@1 is the older, broken tag).  However, the
newer tag retains the history of the broken tag:

	git log tags/proj-1.0

outputs:

	Author: fraggle <fraggle@f01c4a58-e860-4891-ae86-76464917f484>
	Date:   Fri Oct 2 22:37:42 2009 +0000

	    Recreating the tag properly.

	commit 4aeb0a415e5be12d28a8af1128315e44d44a10d7
	Author: fraggle <fraggle@f01c4a58-e860-4891-ae86-76464917f484>
	Date:   Fri Oct 2 22:37:07 2009 +0000

	    Creating a tag in a BROKEN way, like how cvs2svn does it.

	commit 866f94c91de7628d7251098efcc133e6b5900f88
	Author: fraggle <fraggle@f01c4a58-e860-4891-ae86-76464917f484>
	Date:   Fri Oct 2 22:36:41 2009 +0000

	    Initial import.

	commit e8a2ee18774e319d33cb5bd418e03a5281b75268
	Author: fraggle <fraggle@f01c4a58-e860-4891-ae86-76464917f484>
	Date:   Fri Oct 2 22:36:41 2009 +0000

	    Initial import.

We now handle this case properly by renaming the earlier creation of
the tag.

== The tagretract test case ==

According to Mike Fleetwood, fleetwood.svn was created with the following
sequence of operations:

------------------------------------------------------
svn commit -m 'commit one'
svn copy $REPO/trunk $REPO/tags/1.0 -m 'Release 1.0'
svn mv $REPO/tags/1.0 $REPO/tags/1.0rc1 -m 'No release ready yet'
svn commit -m 'commit two'
svn copy $REPO/trunk $REPO/tags/1.0 -m 'Fixed release 1.0'
------------------------------------------------------

He then converted it with these commands:

------------------------------------------------------
branchify_map :tags/(.*)/:tags/\1:
read </tmp/repo.svndump
prefer git
write >/tmp/repo.fi
------------------------------------------------------

This sequence is captured in tagretract.tst.

Before the simplification of permission calculation:
After conversion the tag named '1.0' referred to the first commit with
the first tagging message 'Release 1.0', rather than the second commit
with the second tagging message 'Fixed release 1.0'.

== A note about references.svn ==

This was produced from the NUT Subversion repo as follows:

svncutter -q -r 0:4,6,8,56,58,61,65,350,355,356,543:546 select <nut.svn \
    | svncutter -q expunge 'tags/' \
        'branches/regex_branch' \
        'branches/Tripp_Lite_Omni' \
        'branches/r2.0.1' \
        'branches/v2.1.0' \
        'branches/Stable' \
        '.*/ChangeLog' \
        '.*/CHANGES' \
        '.*/README' \
        '.*/INSTALL' \
        '.*/UPGRADING' \
        '.*/NEWS' \
        '.*/CREDITS' \
        '.*/COPYING' \
        '.*/man/' \
        '.*/docs/' \
        '.*/.*txt' \
        '.*/.cvsignore' \
        '.*/MAINTAINERS' \
        '.*/configure' \
        '.*/config.sub' \
        '.*/config.guess' \
        '.*\.conf' \
        '.*mge.*' \
        '.*hid.*' \
        '.*libupsclient.*' \
        '.*missing.*' \
        '.*aclocal.*' \
        '.*/ltmain.sh' \
        '.*/Makefile.in' \
        '.*/Makefile.am' \
        '.*/stamp.h.in' \
        '.*/depcomp' \
        '.*\.h' \
        'trunk/drivers/megatec.c' \
        'trunk/drivers/optiups.c' \
        'trunk/drivers/tripplite-hid.c' \
        'branches/reportbuf/server/conf.c' \
        'branches/Development/drivers/apc-hid.c' \
        'branches/reportbuf/Makefile' \
        'branches/Testing/drivers/apc-hid.c' \
        'branches/Testing/drivers/tripplite_usb.c' \
        'trunk/drivers/al175.c' \
        'trunk/drivers/apc-hid.c' \
        'trunk/drivers/belkin-hid.c' \
        'branches/reportbuf/packaging/debian' \
        'branches/automake/packaging/debian' \
        'branches/JD-NewConf/common/data_types.c' \
        'branches/JD-NewConf/lib/libupsconfig.c' \
        'branches/JD-NewConf/utils/Makefile.in' \
        'branches/JD-NewConf/utils/migratetool.c' \
        'branches/JD-NewConf/utils/upsconfig.c' \
        'branches/JD-NewConf/clients/upsmon.c' \
        'branches/JD-NewConf/common/nutparser.c' \
        'branches/JD-NewConf/common/tree.c' \
        'branches/JD-NewConf/drivers/main.c' \
        'branches/JD-NewConf/drivers/upsdrvctl.c' \
        'branches/JD-NewConf/server/conf.c' \
        'branches/JD-NewConf/server/user.c' \
        'branches/JD-NewConf/utils/migrateconfig.c' \
        'branches/HAL/Makefile.in' \
        'branches/HAL/drivers' \
        'branches/HAL/utils' \
        'branches/JD-NewConf/conf' \
        'branches/JD-NewConf/drivers' \
        'branches/JD-NewConf/Makefile.in' \
        'branches/reportbuf/drivers' \
        'trunk/drivers/rhino.c' \
        'branches/Testing/drivers/rhino.c' \
        'branches/automake/AUTHORS' \
        'branches/reportbuf/scripts' \
        'trunk/scripts' \
        'trunk/clients' \
        'trunk/server' \
        'branches/Testing/scripts' \
        'branches/Testing/clients' \
        'branches/Testing/server' \
        'branches/Development/scripts' \
        'branches/Development/clients' \
        'branches/Development/server' \
        'branches/Development/drivers/tripplite_usb.c' \
        'branches/Development/drivers/dummy-ups.c' \
        'branches/automake/m4' \
        'branches/automake/clients' \
        'branches/automake/server' \
        'branches/automake/scripts' \
        'branches/Development/data' \
        'branches/automake/data' \
        'trunk/common' \
        'branches/automake/common' \
        'branches/Development/debian' \
        'trunk/packaging' \
        'branches/Development/packaging' \
        'branches/Testing/packaging' \
        'branches/automake/packaging' \
        'branches/automake/.*\.[ch]' \
        'trunk/drivers/belkin.c' \
        'trunk/drivers/belkinunv.c' \
        'trunk/drivers/bestfcom.c' \
        'trunk/drivers/bestuferrups.c' \
        'trunk/drivers/bestups.c' \
        'trunk/drivers/blazer.c' \
        'trunk/drivers/dstate.c' \
        'trunk/drivers/dummycons.c' \
        'trunk/drivers/esupssmart.c' \
        'trunk/drivers/everups.c' \
        'trunk/drivers/genericups.c' \
        'trunk/drivers/liebert.c' \
        'trunk/drivers/masterguard.c' \
        'trunk/drivers/metasys.c' \
        'trunk/drivers/mustek.c' \
        'trunk/drivers/oneac.c' \
        'trunk/drivers/powercom.c' \
        'trunk/drivers/safenet.c' \
        'trunk/drivers/skel.c' \
        'trunk/drivers/sms.c' \
        'trunk/drivers/tripplitesu.c' \
        'trunk/drivers/victronups.c' \
        '.*/apcsmart.c' \
        '.*/ippon.c' \
        '.*/isbmex.c' \
        '.*/powermust.c' \
        '.*/cyberpower.c' \
        '.*/solis.c' \
        '.*/fentonups.c' \
        '.*/tripplite.c' \
        'trunk/Makefile' \
        '.*/energizerups.c' \
        '.*/etapro.c' \
        '.*/upsdrvctl.c' \
        '.*/snmp-ups.c' \
        '.*/cpsups.c' \
        '.*/main.c' \
        '.*/upscode2.c' \
        '.*/bcmxcp.c' \
        'branches/automake/Makefile.dist' \
        '.*/gendb' \
        '.*/version' \
        '.*/install-sh' \
        '.*/upsd.users' \
    | svncutter -q renumber \
>reduced.svn

Later it was stripped and renumbered.  Later still, a 0 revision and
an 89 revision were added to make the revision sequence 0-origin
and continuous, which the Go implementation requires.

It captures the most serious pathologies in the NUT repo.

== Known Issues ==

This is a list of test loads that fail to pass liftcheck,
with explanations. "Not used in any test" means *.tst and *.sh
files - each of these is used as a stability test of the
Subversion lift code.

adventitious.svn::
   A root-level branch defeats the comparison algorithm liftcheck
   uses. Not used by any test.  Cosmetically annoying but not a bug.

agito.svn::
   Processing is correct - the unmatched tags on the Git side are
   from renaming the earlier, deleted version of a tag.  Used by
   lint.tst.

branch-drop-add::
   Processing is correct - the unmatched tags on the Git side are
   from renaming the earlier, deleted version of a branch. Not used
   by any test.

branchify.svn::
   Doesn't build, no trunk branch. Used by branchify.tst.

branchmap.svn::
   Doesn't build, no trunk branch. Used by branchmap.tst.

branchreplace.svn::
   BUG: needs analysis. Used in a repocutter test. Derived 
   from references.svn.

delete-copy.svn::
   Doesn't build, no trunk branch. Not used by any test.

delignore/svn::
   Translation correct. One message due to branch delete
   followed by rename.

emptyfrom.svn::
   BUG: Needs analysis. Not used by any test.

expunge-copyfrom.svn::
   Doesn't build, no trunk branch. Used by expunge-copyfrom.tst.

fleetwood.svn::
   Has empytcommits and a deleted-renamed commit; these are junk. 
   The tags/1.0rc1/ omn the SVN side is never instantiated in the
   git lift because it has no content. Used in tagretract.tst.

format7.svn::
   Has emptycommits. The translation is correct. Not used by any test. 

gitignore.svn::
   Has an emptycommit. Generates a warning about the user-created
   .gitigmore, as it should. Trsnslation is correct.  Used by 
   userignores.tst

myers1.svn::
   Has an emptycommit. Translation is correct. Not used by any test.

nesting.svn::
   Doesn't build, no trunk branch. Used by nesting.tst.

node-kind-first.svn::
   Translation is corrext, but one of the proprty settings triggers
   a spurious message. Not a real bug.  Not used by any test.

references.svn::
   BUG: needs analysis. Used by the legacy-map test.

rootfile.svn::
   Translation is correct, exiguous file produces a root branch.
   Used in a repocutter test.

rootfirst.svn::
   Doesn't build, no trunk branch. Not used by any test.

samplebranch.svn::
   BUG: Git translation preserves a deleted branch, and probably
   should not unless the --preserve read option is on. Uses in
   branchdelete.tst and branchrename.tst.

snarl.svn::
   Translation is correct.  Has empytcommits. A contentless branch
   is not translated. Mot used in any test. Derived from references.svn.

split-dir.svn::
   Translation is correct.  root tag is because root-level directories
   not matching the standard branch structure were created.  Used in
   split-dir.tst.

subclipse.svn::
   Trsnslation is correct.  Has an emptycommit. Not used in any test.

swap.svn::
   Doesn't build, no trunk branch. Used in a repocutter test.

symlink.svn::
   BUG: Probably in repotool. Not used in any test.

treecontents.svn::
   BUG: Possibly in repotool. Why the .gitignore message? Not used in
   any test.

vanilla.svn::
   Translation is correct.  Has an enptycommit, and there's a messqge
   due to a poperty setting. Used in repocutter and repotool tests.

wrong-mergeinfo.svn::
   Translation is correct, produces a message due to unresolved
   mergeinfo. Not used in any test.

== Sporadic tests ==

We have some scripts intended to check Subversion's behavior.

svncheck1.sh:
   Simple check that a file copy propagates the executable bit.

svncheck2.sh:
   A directory copy propagates it too.

svncheck3.sh
   Variant of previous test with different op order.

// end

